<?php//ini_set('display_errors', 1);include_once ROOTPATH . '/modules/agent/inc/message.class.php';if (!isset($message_cls) || !($message_cls instanceof Message)) {    $message_cls = new Message();}$typeMsg = getParams('type_msg');if ($typeMsg == 'lst') {        $where_str = 'm.`agent_id_to`='.$_SESSION['agent']['id'].' AND m.draft = 0';    $p = (int) getParams('p');    if ($p <= 0) {        $p = 1;    }    $len = 20;    $rows = $message_cls->getRows('SELECT SQL_CALC_FOUND_ROWS m.* 						,(SELECT a1.email_address FROM ' . $agent_cls->getTable() . ' AS a1 WHERE a1.agent_id = m.agent_id_from) AS email_from2						,(SELECT a2.email_address FROM ' . $agent_cls->getTable() . ' AS a2 WHERE a2.agent_id = m.agent_id_to) AS email_to2						FROM ' . $message_cls->getTable() . ' AS m 						WHERE ' . $where_str . '						ORDER BY m.message_id DESC						LIMIT ' . ($p - 1) * $len . ',' . $len, true);    $item_count = $message_cls->getFoundRows();    $rows1 = array();    foreach ($rows as $row) {        $dt = new DateTime($row['send_date']);        $row['send_date'] = $dt->format('d M Y') . ' at ' . $dt->format('h A');        if (strlen(trim($row['email_from'])) > 0) {            $row['email_main'] = $row['email_from'];        } else {            $row['email_main'] = $row['email_from2'];        }        list($title, $propertyId) = explode('#', $row['title']);                $row['property_id'] = str_replace('!', '', $propertyId);        $row['content'] = nl2br($row['content']);        $rows1[] = $row;    }    if ($message_cls->hasError()) {        out('0', $message_cls->getError(), '');    } else {        $data = array('p' => $p, 'item_per_page' => $len, 'item_count' => $item_count, 'data' => $rows1);        out('1', '', $data);    }} else if ($typeMsg == 'view') {    $message_id = getParams('msg_id', 0);    if ($message_id > 0) {        $message_cls->update(array('read' => 1), 'message_id = ' . $message_id);    }        die();}?>